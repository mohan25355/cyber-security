<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MCQ Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <div class="max-w-4xl mx-auto p-4">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-xl font-semibold">MCQ Test</h1>
      <div class="flex items-center gap-4">
        <span id="studentName" class="text-gray-700"></span>
        <span id="warnings" class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 text-sm">Warnings: 0</span>
        <span id="timer" class="px-3 py-1 rounded-full bg-black text-white text-sm">50:00</span>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow p-4" id="questions"></div>

    <div class="flex justify-end mt-6 gap-3">
      <button id="fullscreenBtn" class="px-4 py-2 rounded-xl border">Go Full Screen</button>
      <button id="submitBtn" class="px-4 py-2 rounded-xl bg-black text-white">Submit Test</button>
    </div>

    <p class="text-sm text-gray-500 mt-4">⚠️ Do not switch tabs, minimize, exit fullscreen, or open dev tools. 3 warnings = auto-submit.</p>
  </div>

  <script type="module" src="./common.js"></script>
  <script src="./questions.js"></script>
  <script type="module">
    const { db, fns } = window.__FIREBASE__;
    const { doc, updateDoc, serverTimestamp } = fns;

    const attemptId = localStorage.getItem('attemptId');
    if (!attemptId) {
      alert('No attempt found. Please register again.');
      window.location.href = './index.html';
    }

    document.getElementById('studentName').textContent = localStorage.getItem('studentName') || '';

    // Render questions
    const container = document.getElementById('questions');
    container.innerHTML = window.QUESTIONS.map((q, i) => `
      <div class="border-b py-4">
        <p class="font-medium">Q${i+1}. ${q.q}</p>
        <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
          ${q.options.map((opt, idx) => `
            <label class="flex items-center gap-2 border rounded-xl p-2">
              <input type="radio" name="q${i}" value="${idx}" />
              <span>${opt}</span>
            </label>
          `).join('')}
        </div>
      </div>
    `).join('');

    // Timer (50 minutes default)
    const durationMins = 50;
    let secondsLeft = durationMins * 60;
    const timerEl = document.getElementById('timer');

    const tick = () => {
      const m = String(Math.floor(secondsLeft / 60)).padStart(2, '0');
      const s = String(secondsLeft % 60).padStart(2, '0');
      timerEl.textContent = `${m}:${s}`;
      secondsLeft--;
      if (secondsLeft < 0) submitTest();
    };
    tick();
    const interval = setInterval(tick, 1000);

    // Anti-cheat: count warnings
    let warnings = 0;
    const warningsEl = document.getElementById('warnings');

    const addWarning = async () => {
      warnings++;
      warningsEl.textContent = `Warnings: ${warnings}`;
      try { await updateDoc(doc(db, 'attempts', attemptId), { warnings }); } catch {}
      if (warnings >= 3) {
        alert('3 warnings reached. Auto-submitting your test.');
        submitTest();
      }
    };

    // Detect tab switch/minimize
    window.addEventListener('blur', addWarning);
    document.addEventListener('visibilitychange', () => { if (document.hidden) addWarning(); });

    // Detect exit from fullscreen
    document.addEventListener("fullscreenchange", () => {
      if (!document.fullscreenElement) addWarning();
    });

    // Block right-click
    document.addEventListener("contextmenu", e => e.preventDefault());

    // Block F12 / Ctrl+Shift+I/J/C
    document.addEventListener("keydown", e => {
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && ["I","C","J"].includes(e.key))) {
        e.preventDefault();
        addWarning();
      }
    });

    // Prevent closing/refresh
    window.onbeforeunload = (e) => { e.preventDefault(); e.returnValue = ''; };

    // Fullscreen helper
    const fsBtn = document.getElementById('fullscreenBtn');
    fsBtn.addEventListener('click', async () => {
      if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
    });

    // Collect answers and submit
    async function submitTest() {
      clearInterval(interval);
      window.onbeforeunload = null;

      const answers = [];
      let score = 0;
      window.QUESTIONS.forEach((q, i) => {
        const sel = document.querySelector(`input[name="q${i}"]:checked`);
        const val = sel ? Number(sel.value) : -1;
        answers.push(val);
        if (val === q.answer) score++;
      });

      try {
        await updateDoc(doc(db, 'attempts', attemptId), {
          status: 'submitted',
          score,
          answers,
          submittedAt: serverTimestamp(),
        });
      } catch (err) {
        console.error('Update error', err);
      }

      localStorage.setItem('lastScore', String(score));
      window.location.href = './result.html';
    }

    document.getElementById('submitBtn').addEventListener('click', submitTest);
  </script>
</body>
</html>
